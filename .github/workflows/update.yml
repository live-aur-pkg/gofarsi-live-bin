name: Gofarsi book AUR Auto-Updater

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-aur:
    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
      - name: Checkout GitHub Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Arch Dependencies
        run: |
          # Initialize pacman keys and install required tools
          pacman-key --init
          pacman -Syu --noconfirm base-devel pacman-contrib git curl jq openssh

      - name: Create non-root builder user
        run: |
          # makepkg refuses to run as root. We create a 'builder' user and give them ownership of the repo folder.
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .

      - name: Check Version and Update Files
        id: updater
        run: |
          chmod a+w "$GITHUB_OUTPUT"
          su builder -c '
            echo "Fetching latest release from GitHub API..."
            # Safely grab the latest tag using jq and strip the "v" prefix
            LATEST_VER=$(curl -sL https://api.github.com/repos/GoFarsi/book/releases/latest | jq -r ".tag_name" | sed "s/^v//")
            CURRENT_VER=$(grep "^pkgver=" PKGBUILD | cut -d= -f2)

            echo "Current version: $CURRENT_VER"
            echo "Latest version: $LATEST_VER"

            if [ "$LATEST_VER" = "$CURRENT_VER" ] || [ "$LATEST_VER" = "null" ]; then
              echo "No new version found. Exiting."
              echo "updated=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "New version detected! Updating PKGBUILD..."

            # Update the version and reset the release number to 1
            sed -i "s/^_pkgver=.*/_pkgver=$LATEST_TAG/" PKGBUILD
            sed -i "s/^pkgver=.*/pkgver=$ARCH_PKGVER/" PKGBUILD
            sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

            echo "Generating new .SRCINFO..."
            makepkg --printsrcinfo > .SRCINFO

            echo "updated=true" >> $GITHUB_OUTPUT
            echo "new_version=$LATEST_VER" >> $GITHUB_OUTPUT
          '

      - name: Deploy to AUR
        if: steps.updater.outputs.updated == 'true'
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        run: |
          echo "Setting up SSH for AUR..."
          mkdir -p ~/.ssh
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t ed25519 aur.archlinux.org >> ~/.ssh/known_hosts

          echo "Cloning the AUR repository..."
          git clone ssh://aur@aur.archlinux.org/visual-studio-code-live-bin.git /tmp/aur_repo

          echo "Copying updated files to AUR repo..."
          cp PKGBUILD .SRCINFO /tmp/aur_repo/

          cd /tmp/aur_repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add PKGBUILD .SRCINFO
          git commit -m "Update to v${{ steps.updater.outputs.new_version }}"
          git push origin master

      - name: Commit and Push to GitHub
        if: steps.updater.outputs.updated == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git config --global --add safe.directory /__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}

          git add PKGBUILD .SRCINFO
          git commit -m "chore: auto-update to v${{ steps.updater.outputs.new_version }}"
          git push origin main